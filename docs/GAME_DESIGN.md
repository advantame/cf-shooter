# ゲーム設計書

## 概要

3人対戦のスマホ向けリアルタイムシューティングゲーム。クライアント権威モデルを採用し、低遅延な操作感を実現。

## ゲームルール

### 基本ルール

| 項目 | 値 | 備考 |
|------|-----|------|
| 最大プレイヤー数 | 3人 | ルームごと |
| 初期HP | 200 | |
| マップ形状 | 円形（ピザ型3分割） | 画面サイズに依存 |
| 勝利条件 | (未実装) | |
| リスポーン | (未実装) | |

### フィールド

- 円形のアリーナを120度ずつ3分割（ピザ型）
- 各プレイヤーは割り当てられた扇形領域内のみ移動可能
- 弾は領域を越えて飛行可能

### 操作方法（スマホ）

| 画面領域 | 操作 | 機能 |
|----------|------|------|
| 下半分 | スワイプ | 自機移動 |
| 上半分 | 左右スワイプ | 照準調整 |

- 両手で同時操作可能（マルチタッチ対応）
- 射撃は自動（常時連射）
- PC: マウスドラッグで同等の操作

### 視点

- 各プレイヤーから見て、自分の領域が常に画面下側に表示される
- フィールド全体が回転して描画される

## エンティティ仕様

### プレイヤー

| パラメータ | 値 | 定数名 |
|-----------|-----|--------|
| 移動速度 | SIZE × 0.8 px/sec | `SPEED` |
| 当たり判定半径 | PLAYER_RADIUS × 1.2 | |
| 表示サイズ | SIZE × 0.04 | `PLAYER_RADIUS` |
| 初期位置 | 割り当て領域の中央 | |

### 弾

| パラメータ | 値 | 定数名 |
|-----------|-----|--------|
| 弾速 | SIZE × 2.1 px/sec | `BULLET_SPEED` |
| 発射クールダウン | 80 ms | `SHOT_COOLDOWN_MS` |
| ダメージ | 1 HP | |
| 発射形態 | 二股（±0.35 rad） | `FORK_ANGLE` |
| 射撃方向 | 中心方向 + 照準オフセット | 固定角度 |
| 寿命 | アリーナ外で消滅 | |

## 通信プロトコル

### 概要

- プロトコル: WebSocket
- データ形式: JSON
- サーバー: 中継専用（約30Hz）
- クライアント: ゲームロジック実行（60fps）

### メッセージ型定義

```typescript
// === クライアント → サーバー ===

type ClientMsg =
  | StateMsg
  | HitMsg;

interface StateMsg {
  type: "state";
  id: string;           // プレイヤーID
  x: number;            // X座標
  y: number;            // Y座標
  hp: number;           // 残りHP
  zone: number;         // 領域番号 (0-2)
  bullets: Array<{      // 弾の位置
    x: number;
    y: number;
    vx: number;
    vy: number;
  }>;
}

interface HitMsg {
  type: "hit";
  targetId: string;     // 被弾したプレイヤーのID
}

// === サーバー → クライアント ===

type ServerMsg =
  | HelloMsg
  | PlayersMsg
  | HitMsg
  | ErrorMsg;

interface HelloMsg {
  type: "hello";
  playerId: string;     // UUID形式
  zone: number;         // 割り当てられた領域 (0-2)
}

interface PlayersMsg {
  type: "players";
  players: {
    [playerId: string]: {
      x: number;
      y: number;
      hp: number;
      zone: number;
      bullets: Array<{ x: number; y: number }>;
    };
  };
}

interface HitMsg {
  type: "hit";
  targetId: string;
  fromId: string;
}

interface ErrorMsg {
  type: "error";
  message: string;
}
```

### 接続フロー

```
クライアント                    サーバー
    |                              |
    |-- WebSocket接続 ------------->|
    |                              |
    |<--------- hello -------------|  (playerId, zone発行)
    |                              |
    |-- state (60fps) ------------>|  (自分の状態を送信)
    |                              |
    |<------- players (30Hz) ------|  (全員の状態を中継)
    |                              |
    |-- hit ---------------------->|  (ヒット通知)
    |                              |
    |<-------- hit ----------------|  (被弾通知を中継)
    |                              |
```

## ゲームループ

### クライアント側 (60fps)

```
1. 入力処理
   - スワイプ入力を収集
   - 移動方向・照準オフセット計算

2. ゲームロジック
   - 自機の移動（領域内に制限）
   - 弾の生成（常時連射）
   - 弾の移動
   - 当たり判定（自分の弾 vs 他プレイヤー）
   - ヒット時: サーバーに通知

3. 状態送信
   - 自分の位置・HP・弾をサーバーに送信

4. 補間処理
   - 他プレイヤーの表示位置を滑らかに補間

5. 描画
   - 回転変換（自分の領域を下に）
   - フィールド → 弾 → プレイヤー の順
```

### サーバー側 (約30Hz)

```
1. 受信
   - 各クライアントの状態を保存

2. 中継
   - 全クライアントの状態をまとめて全員に配信

3. ヒット通知中継
   - hitメッセージを全員に転送
```

## 視覚効果

### 補間（Interpolation）

- 他プレイヤーの位置を線形補間で滑らかに描画
- LERP_SPEED = 18 で素早く追従
- ヒット判定は補間前の実位置を使用（厳密）

### UIインジケーター

- 照準方向を示す矢印（操作中は明るく表示）
- 移動スワイプの軌跡
- 画面分割線（上下を区切る薄い線）

## 拡張予定

### 近日実装予定

- [ ] **リスポーン**: 死亡後N秒で復活
- [ ] **ラウンド制**: 最後の1人が勝利
- [ ] **キルログ**: 誰が誰を倒したか表示

### 検討中

- [ ] **武器種追加**: ショットガン、レーザー等
- [ ] **アイテム**: 回復、スピードアップ
- [ ] **スキル**: クールダウン付きの特殊能力

## チート対策

### 現状の方針

- 身内用ゲームのため、チート対策は最小限
- クライアント権威モデル（低遅延優先）

### 想定されるチート

| チート | 可能性 | 備考 |
|--------|--------|------|
| 位置詐称 | 可能 | 領域外への移動など |
| HP詐称 | 可能 | ダメージ無効化 |
| 弾速改ざん | 可能 | 超高速弾 |

※ 公開ゲームにする場合はサーバー権威モデルへの移行を推奨
