# ゲーム設計書

## 概要

3人対戦のリアルタイムシューティングゲーム。サーバー権威モデルを採用し、チート耐性を確保。

## ゲームルール

### 基本ルール

| 項目 | 値 | 備考 |
|------|-----|------|
| 最大プレイヤー数 | 3人 | ルームごと |
| 初期HP | 5 | |
| マップサイズ | 800 x 600 px | |
| 勝利条件 | (未実装) | |
| リスポーン | (未実装) | |

### 操作方法

| 操作 | キー/マウス | タッチ |
|------|------------|--------|
| 移動 | WASD / 矢印キー | (未実装) |
| 照準 | マウス移動 | タッチ位置 |
| 射撃 | スペース / クリック | タッチ |

## エンティティ仕様

### プレイヤー

| パラメータ | 値 | 定数名 |
|-----------|-----|--------|
| 移動速度 | 180 px/sec | `SPEED` |
| 当たり判定半径 | 18 px | ハードコード |
| 表示サイズ | 半径 16 px | ハードコード |
| 初期位置 | ランダム (80-720, 80-520) | |

### 弾

| パラメータ | 値 | 定数名 |
|-----------|-----|--------|
| 弾速 | 420 px/sec | `BULLET_SPEED` |
| 発射クールダウン | 180 ms | `SHOT_COOLDOWN_MS` |
| ダメージ | 1 HP | ハードコード |
| 寿命 | 画面外で消滅 | |

## 通信プロトコル

### 概要

- プロトコル: WebSocket
- データ形式: JSON
- サーバーTick: 20 Hz (50ms)
- クライアント入力送信: 約30 Hz (33ms)

### メッセージ型定義

```typescript
// === クライアント → サーバー ===

type ClientMsg =
  | InputMsg
  | PingMsg;

interface InputMsg {
  type: "input";
  seq: number;        // シーケンス番号
  up: boolean;        // 上移動
  down: boolean;      // 下移動
  left: boolean;      // 左移動
  right: boolean;     // 右移動
  shoot: boolean;     // 射撃
  aimX: number;       // 照準X座標 (0-800)
  aimY: number;       // 照準Y座標 (0-600)
}

interface PingMsg {
  type: "ping";
  t: number;          // クライアントタイムスタンプ
}

// === サーバー → クライアント ===

type ServerMsg =
  | HelloMsg
  | StateMsg
  | ErrorMsg;

interface HelloMsg {
  type: "hello";
  playerId: string;   // UUID形式
}

interface StateMsg {
  type: "state";
  t: number;          // サーバータイムスタンプ
  players: {
    [playerId: string]: {
      x: number;      // X座標
      y: number;      // Y座標
      hp: number;     // 残りHP
    };
  };
  bullets: Array<{
    x: number;
    y: number;
  }>;
}

interface ErrorMsg {
  type: "error";
  message: string;
}
```

### 接続フロー

```
クライアント                    サーバー
    |                              |
    |-- WebSocket接続 ------------->|
    |                              |
    |<--------- hello -------------|  (playerId発行)
    |                              |
    |-- input (30Hz) ------------->|
    |                              |
    |<-------- state (20Hz) -------|
    |                              |
```

## ゲームループ

### サーバー側 (20Hz)

```
1. 入力反映
   - 各プレイヤーの lastInput を読み取り
   - 移動ベクトル計算・正規化
   - 座標更新 (clamp処理)
   - 射撃判定・弾生成

2. 物理演算
   - 弾の移動
   - 画面外弾の削除

3. 当たり判定
   - 弾 vs プレイヤー (円形判定)
   - ヒット時: HP減少、弾削除

4. 状態配信
   - 全プレイヤーにStateMsg送信
```

### クライアント側

```
入力ループ (33ms):
  - キー/マウス状態を収集
  - InputMsg送信

描画ループ (requestAnimationFrame):
  - 最新のStateMsg描画
  - 背景 → 弾 → プレイヤー の順
```

## 拡張予定

### 近日実装予定

- [ ] **リスポーン**: 死亡後N秒で復活
- [ ] **ラウンド制**: 最後の1人が勝利、N勝で試合終了
- [ ] **キルログ**: 誰が誰を倒したか表示

### 検討中

- [ ] **武器種追加**: ショットガン、スナイパー等
- [ ] **アイテム**: 回復、弾薬、スピードアップ
- [ ] **障害物**: 壁、遮蔽物
- [ ] **スキル**: クールダウン付きの特殊能力

### 遅延対策 (上級)

- [ ] **クライアント予測**: 自機の入力を即座に反映
- [ ] **補間処理**: 他プレイヤーを過去2フレームで補間
- [ ] **ラグ補償**: サーバー側で過去状態を巻き戻し判定

## チート対策

### 現状の対策

- サーバー権威モデル (クライアントは入力のみ送信)
- 座標計算はサーバー側で実行

### 追加すべき対策

| 対策 | 説明 | 優先度 |
|------|------|--------|
| 入力頻度制限 | 秒間N回以上の入力を無視 | 高 |
| 速度検証 | 1tick内の移動量上限チェック | 高 |
| クールダウン厳守 | サーバー側でも射撃間隔を検証 | 中 |
| 不正パケット検知 | 異常な値を送るクライアントを切断 | 中 |
